<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Points Market & Inventory | FATBLOX57</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #05080f; --sidebar: #0b1224; --text: #ffffff;
            --accent: #00d4ff; --card: #111827; --border: #1f2937;
            --gold: #fbbf24; --success: #10b981; --error: #ef4444; --purple: #a855f7;
        }
        [data-theme="light"] {
            --bg: #f3f4f6; --sidebar: #ffffff; --text: #111827;
            --accent: #0052cc; --card: #ffffff; --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* --- SIDEBAR --- */
        nav.sidebar { 
            width: 260px; background: var(--sidebar); height: 100vh; 
            position: fixed; left: 0; top: 0; padding: 40px 20px; border-right: 1px solid var(--border);
            z-index: 1000; display: flex; flex-direction: column;
        }
        .logo { font-size: 1.8rem; font-weight: 900; color: var(--accent); margin-bottom: 30px; letter-spacing: 1px; text-align: left; }
        .nav-link { 
            text-decoration: none; color: var(--text); padding: 12px 15px; 
            margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-weight: 600; opacity: 0.8; font-size: 1rem;
        }
        .nav-link:hover, .nav-link.active { background: var(--accent); color: white; opacity: 1; }
        .market-tab { border: 2px dashed var(--gold); color: var(--gold) !important; opacity: 1; margin-top: 10px; background: rgba(251, 191, 36, 0.05); }
        .market-tab.active, .market-tab:hover { background: var(--gold) !important; color: #000 !important; border-style: solid; }

        /* --- 4 CIRCLE ICONS --- */
        .sidebar-footer { margin-top: auto; padding: 20px 0 0 0; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--border); }
        .circle-btn { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--card); 
            border: 1px solid var(--border); color: var(--text); display: flex; 
            align-items: center; justify-content: center; font-size: 1.2rem; 
            cursor: pointer; text-decoration: none; transition: 0.2s; 
        }
        .circle-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .profile-circle { background: var(--accent); color: white; border-color: var(--accent); font-weight: 900; font-size: 1.4rem; }

        /* --- RIGHT GIFT SIDEBAR --- */
        .gift-sidebar {
            position: fixed; right: -320px; top: 0; width: 320px; height: 100vh;
            background: var(--sidebar); border-left: 1px solid var(--border);
            z-index: 2000; padding: 30px 20px; transition: right 0.3s ease;
            display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.5);
        }
        .gift-sidebar.open { right: 0; }
        .gs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gs-header h2 { color: var(--gold); font-size: 1.3rem; }
        .gs-icons { display: flex; gap: 10px; }
        .gs-icon-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); font-size: 0.9rem; cursor: pointer; padding: 8px 10px; border-radius: 8px; }
        
        .gs-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .gs-tab { flex: 1; padding: 10px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-align: center; }
        .gs-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .gift-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; }
        .g-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .g-card h4 { color: var(--accent); margin-bottom: 5px; font-size: 1rem; }

        /* --- MAIN CONTENT AREA --- */
        main { margin-left: 260px; padding: 40px; width: 100%; transition: margin-right 0.3s; }
        
        .economy-bar { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px 30px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-wrap: wrap; gap: 15px; }
        .economy-bar h2 { font-size: 1.8rem; margin-bottom: 5px; }
        .economy-bar p { opacity: 0.6; font-size: 0.9rem; }
        
        .point-display { background: rgba(251, 191, 36, 0.1); border: 1px solid var(--gold); padding: 10px 20px; border-radius: 12px; color: var(--gold); font-weight: 900; font-size: 1.3rem; display: flex; align-items: center; gap: 15px; }
        .gift-main-btn { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 900; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; align-items: center; }
        .tab-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 0.95rem; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .ad-btn { background: var(--purple); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 800; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .item-card { background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
        .item-card h3 { color: var(--text); margin-bottom: 5px; font-size: 1.3rem; }
        .price { color: var(--gold); font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .count-badge { position: absolute; top: 15px; right: 15px; background: var(--accent); padding: 5px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 900; color: white; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 900; font-size: 0.95rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-buy { background: var(--accent); color: white; }
        .btn-sell { background: var(--error); color: white; }
        .btn-cancel { background: var(--border); color: var(--text); margin-top: 15px; }

        /* --- COMPACT MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(3, 7, 18, 0.9); backdrop-filter: blur(5px); z-index: 6000; display: none; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .modal-card { background: var(--card); padding: 40px 30px; border-radius: 25px; border: 1px solid var(--accent); width: 100%; max-width: 400px; box-shadow: 0 15px 50px rgba(0,212,255,0.2); }
        .modal-card h2 { color: var(--text); margin-bottom: 10px; font-size: 1.8rem; }
        .modal-card p.subtitle { opacity: 0.6; margin-bottom: 25px; font-size: 0.95rem; }
        .modal-card input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text); text-align: center; font-size: 1rem; outline: none; }
        .modal-card input:focus { border-color: var(--accent); }

        /* --- MOBILE --- */
        .menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 1100; background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        
        @media (max-width: 768px) {
            nav.sidebar { transform: translateX(-100%); width: 280px; }
            nav.sidebar.open { transform: translateX(0); }
            main { margin-left: 0; padding: 80px 20px 40px 20px; }
            .economy-bar { padding: 25px 20px; flex-direction: column; text-align: center; justify-content: center; }
            .point-display { width: 100%; justify-content: space-between; }
            .menu-btn { display: block; }
            #overlay.active { display: block; }
            .gift-sidebar { width: 100%; right: -100%; }
            .tabs { flex-direction: column; }
            .tab-btn, .ad-btn { width: 100%; text-align: center; justify-content: center; }
        }
    </style>
</head>
<body data-theme="dark">

    <div id="customAlert" class="modal-overlay">
        <div class="modal-card" style="max-width: 350px;">
            <i id="alertIcon" class="fas fa-bell" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 id="alertTitle" style="font-size: 1.5rem;">Notification</h2>
            <p id="alertMessage" class="subtitle" style="margin-bottom: 25px;">Message goes here</p>
            <button class="btn btn-buy" onclick="closeAlert()">GOT IT</button>
        </div>
    </div>

    <div id="giftModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 400px;">
            <i class="fas fa-gift" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
            <h2>Send Gift</h2>
            <p class="subtitle">Transfer points directly to another player.</p>
            <input type="text" id="giftTarget" placeholder="Receiver's Roblox Username">
            <input type="number" id="giftAmount" placeholder="Amount of Points">
            <button class="btn btn-buy" style="background: var(--success);" onclick="submitGift()">SEND POINTS</button>
            <button class="btn btn-cancel" onclick="closeGiftModal()">CANCEL</button>
        </div>
    </div>

    <div id="videoModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 550px; padding: 25px;">
            <h2>Earn Points</h2>
            <p class="subtitle">Watch the video to earn 5 points! Click video to visit Creator.</p>
            <div style="position: relative; border-radius: 12px; overflow: hidden; background: #000; border: 2px solid var(--accent);">
                <video id="adVideo" src="Video_Generation_Request.mp4" width="100%" playsinline preload="auto" style="display: block; pointer-events: none;"></video>
                <div style="position: absolute; top:0; left:0; width:100%; height:100%; cursor: pointer;" onclick="window.open('https://www.youtube.com/@SpyraZ', '_blank')"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-buy" id="claimAdBtn" style="display:none; width: 100%; background: #fbbf24; color: #000;" onclick="claimAdReward()"><i class="fas fa-coins"></i> CLAIM 5 POINTS</button>
                <button class="btn btn-cancel" id="closeAdBtn" style="margin-top: 0; width: 100%;" onclick="closeAdModal()">Close Early(LOSE)</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="modal-overlay">
        <div class="modal-card">
            <h2 id="authTitle">Login</h2>
            <p class="subtitle" id="authSubtitle">Secure your assets.</p>
            <input type="text" id="authId" placeholder="Roblox Username">
            <input type="password" id="authPass" placeholder="Password">
            <button class="btn" style="background: var(--purple); color: white;" onclick="submitAuth()" id="authSubmitBtn">ACCESS ACCOUNT</button>
            <div style="margin-top: 20px; cursor: pointer; color: var(--text); opacity: 0.6; font-size: 0.9rem;" onclick="toggleAuthMode()" id="authToggleText">New player? Create an Account</div>
        </div>
    </div>

    <button class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <div id="overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="logo">FATBLOX57</div>
        <a href="index.html" class="nav-link">Home</a>
        <a href="quiz.html" class="nav-link">Verification</a>
        <a href="giveaway.html" class="nav-link">Giveaway</a>
        <a href="spin.html" class="nav-link">Daily Spin</a>
        <a href="leaderboard.html" class="nav-link">Leaderboard</a>
        <a href="market.html" class="nav-link market-tab active"><i class="fas fa-shopping-cart"></i> Points Market</a>

        <div class="sidebar-footer" id="sidebarAuth"></div>
    </nav>

    <aside class="gift-sidebar" id="giftSidebar">
        <div class="gs-header">
            <h2>üéÅ Gift Center</h2>
            <div class="gs-icons">
                <button onclick="loadCloudData()" class="gs-icon-btn"><i class="fas fa-sync-alt" id="giftSyncIcon"></i></button>
                <button onclick="toggleGiftSidebar()" class="gs-icon-btn"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <button class="btn btn-buy" style="margin-bottom: 20px; background: var(--success);" onclick="openGiftModal()">+ SEND POINTS</button>
        
        <div class="gs-tabs">
            <div class="gs-tab active" id="tabReceivedBtn" onclick="setGiftTab('received')">Inbox</div>
            <div class="gs-tab" id="tabSentBtn" onclick="setGiftTab('sent')">Outbox</div>
        </div>
        <div id="viewReceived" class="gift-list"></div>
        <div id="viewSent" class="gift-list" style="display: none;"></div>
    </aside>

    <main id="mainContent">
        <div class="economy-bar">
            <div>
                <h2 id="displayUser">Guest</h2>
                <p>Global Trading Hub</p>
            </div>
            <div class="point-display">
                <span>üí∞ <span id="displayCoins">0</span></span>
                <button class="gift-main-btn" onclick="toggleGiftSidebar()"><i class="fas fa-gift"></i> GIFTS</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="marketBtn" onclick="showTab('market')">Marketplace</button>
            <button class="tab-btn" id="inventoryBtn" onclick="showTab('inventory')">My Inventory</button>
            <button class="ad-btn" onclick="openAdModal()"><i class="fas fa-play-circle"></i> Watch Ad (+5 Pts)</button>
        </div>

        <div id="marketView" class="grid"></div>
        <div id="inventoryView" class="grid" style="display: none;"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0am45IuFAWXViWjnZiDPsddmbPUF3rZY",
            authDomain: "fatblox-43609.firebaseapp.com",
            projectId: "fatblox-43609",
            storageBucket: "fatblox-43609.firebasestorage.app",
            messagingSenderId: "104409498644",
            appId: "1:104409498644:web:ca1d5ecd367ec0fcd85301",
            databaseURL: "https://fatblox-43609-default-rtdb.firebaseio.com/" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const FRUITS = {
            "Rocket": 50, "Spin": 75, "Blade": 500, "Spring": 600, "Bomb": 800,
            "Smoke": 1000, "Spike": 1800, "Flame": 2500, "Dark": 4000, "Sand": 4200,
            "Ice": 5500, "Rubber": 7000, "Eagle": 8000, "Ghost": 8000, "Light": 8000,
            "Diamond": 10000, "Quake": 10000, "Magma": 11500, "Love": 15000, "Spider": 15000,
            "Sound": 25000, "Phoenix": 27500, "Creation": 35000, "Blizzard": 50000,
            "Shadow": 65000, "Gravity": 100000, "Pain": 100000, "Buddha": 100000,
            "Portal": 100000, "Spirit": 100000, "Mammoth": 100000, "T-Rex": 200000,
            "Venom": 200000, "Dough": 300000, "Gas": 600000, "Lightning": 800000,
            "Control": 1400000, "Yeti": 1500000, "Tiger": 1600000, "Kitsune": 4600000,
            "East Dragon": 30500000, "West Dragon": 35100000
        };

        let state = {
            user: localStorage.getItem('rbx_id'),
            coins: 0,
            inventory: {},
            gifts: { sent: [], received: [] }
        };

        window.showCustomAlert = function(msg, title="Notification", isError=false) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            let icon = document.getElementById('alertIcon');
            icon.className = isError ? "fas fa-exclamation-circle" : "fas fa-check-circle";
            icon.style.color = isError ? "var(--error)" : "var(--success)";
            document.getElementById('customAlert').style.display = 'flex';
        }
        window.closeAlert = function() { document.getElementById('customAlert').style.display = 'none'; }

        let isLoginMode = true;
        window.triggerLogin = function() { document.getElementById('authModal').style.display = 'flex'; }
        
        window.toggleAuthMode = function() {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "Login" : "Create Account";
            document.getElementById('authSubtitle').innerText = isLoginMode ? "Secure your assets." : "Join the economy.";
            document.getElementById('authSubmitBtn').innerText = isLoginMode ? "ACCESS ACCOUNT" : "REGISTER NOW";
            document.getElementById('authToggleText').innerText = isLoginMode ? "New player? Create an Account" : "Already registered? Login";
        }

        window.submitAuth = async function() {
            let id = document.getElementById('authId').value.trim().toLowerCase();
            let pass = document.getElementById('authPass').value.trim();
            if (id.length < 3 || pass.length < 3) return showCustomAlert("Username and Password must be at least 3 characters long.", "Error", true);

            document.getElementById('authSubmitBtn').innerText = "Loading...";

            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, `users/${id}`));

                if (isLoginMode) {
                    if (snapshot.exists() && snapshot.val().password === pass) {
                        localStorage.setItem('rbx_id', id); location.reload();
                    } else { 
                        showCustomAlert("Incorrect Username or Password!", "Error", true); 
                        document.getElementById('authSubmitBtn').innerText = "ACCESS ACCOUNT";
                    }
                } else {
                    if (snapshot.exists()) {
                        showCustomAlert("Username is already registered! Switch to Login.", "Error", true);
                        document.getElementById('authSubmitBtn').innerText = "REGISTER NOW";
                        return;
                    }
                    await set(ref(db, `users/${id}`), { password: pass, coins: 0, inventory: {} });
                    localStorage.setItem('rbx_id', id);
                    alert("Account created successfully!");
                    location.reload();
                }
            } catch(e) {
                console.error(e);
                showCustomAlert("Database connection error.", "Error", true);
                document.getElementById('authSubmitBtn').innerText = isLoginMode ? "ACCESS ACCOUNT" : "REGISTER NOW";
            }
        }

        window.logout = function() { localStorage.removeItem('rbx_id'); location.reload(); }

        window.loadCloudData = async function() {
            if (!state.user) return;
            document.getElementById('giftSyncIcon').classList.add('fa-spin');
            try {
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, `users/${state.user}`));
                if (snapshot.exists()) {
                    let data = snapshot.val();
                    state.coins = data.coins || 0;
                    state.inventory = data.inventory || {};
                    
                    // Convert Firebase objects to arrays for sorting
                    state.gifts.sent = data.gifts && data.gifts.sent ? Object.values(data.gifts.sent) : [];
                    state.gifts.received = data.gifts && data.gifts.received ? Object.values(data.gifts.received) : [];
                }
                updateUI(); renderInventory(); renderGifts();
            } catch (err) { console.error("Cloud load error:", err); }
            document.getElementById('giftSyncIcon').classList.remove('fa-spin');
        }

        window.syncCloud = async function() {
            if (!state.user) return;
            try {
                await update(ref(db, `users/${state.user}`), {
                    coins: state.coins,
                    inventory: state.inventory
                });
            } catch(e) { console.error("Cloud sync error:", e); }
        }

        window.openAdModal = function() {
            if(!state.user) return triggerLogin();
            document.getElementById('videoModal').style.display = 'flex';
            let vid = document.getElementById('adVideo');
            document.getElementById('claimAdBtn').style.display = 'none';
            document.getElementById('closeAdBtn').style.display = 'block';
            vid.currentTime = 0;
            vid.play().catch(e => console.log("Waiting for user interaction."));
        }

        document.getElementById('adVideo').addEventListener('ended', function() {
            document.getElementById('claimAdBtn').style.display = 'block';
            document.getElementById('closeAdBtn').style.display = 'none';
        });

        window.closeAdModal = function() { document.getElementById('videoModal').style.display = 'none'; document.getElementById('adVideo').pause(); }
        
        window.claimAdReward = function() {
            state.coins += 5; 
            updateUI(); 
            syncCloud(); 
            closeAdModal();
            showCustomAlert("You watched the full ad and earned 5 Points!", "Reward Claimed!");
        }

        // --- ENHANCED GIFTING SYSTEM (FIREBASE ATOMIC UPDATES) ---
        window.toggleGiftSidebar = function() {
            if (!state.user) return triggerLogin();
            document.getElementById('giftSidebar').classList.toggle('open');
            loadCloudData();
        }

        window.setGiftTab = function(tab) {
            document.getElementById('tabReceivedBtn').classList.toggle('active', tab === 'received');
            document.getElementById('tabSentBtn').classList.toggle('active', tab === 'sent');
            document.getElementById('viewReceived').style.display = tab === 'received' ? 'flex' : 'none';
            document.getElementById('viewSent').style.display = tab === 'sent' ? 'flex' : 'none';
        }
        
        window.openGiftModal = function() {
            document.getElementById('giftTarget').value = ''; 
            document.getElementById('giftAmount').value = ''; 
            document.getElementById('giftModal').style.display = 'flex';
        }
        window.closeGiftModal = function() { document.getElementById('giftModal').style.display = 'none'; }

        window.submitGift = async function() {
            let target = document.getElementById('giftTarget').value.toLowerCase().trim();
            let amt = parseInt(document.getElementById('giftAmount').value);
            
            if (!target) return showCustomAlert("Please enter a username.", "Error", true);
            if (target === state.user) return showCustomAlert("You cannot gift yourself!", "Error", true);
            if (isNaN(amt) || amt <= 0) return showCustomAlert("Invalid amount.", "Error", true);
            if (amt > state.coins) return showCustomAlert("You don't have enough points!", "Error", true);

            closeGiftModal();
            showCustomAlert(`Sending ${amt} points to ${target}...`, "Processing");

            try {
                const dbRef = ref(db);
                const receiverSnap = await get(child(dbRef, `users/${target}`));
                
                if(!receiverSnap.exists()) {
                    return showCustomAlert("This user does not exist in the database.", "Error", true);
                }

                let receiverCoins = receiverSnap.val().coins || 0;
                let giftId = "GIFT_" + Date.now().toString();
                
                let giftRecord = {
                    id: giftId,
                    sender: state.user,
                    receiver: target,
                    amount: amt,
                    timestamp: Date.now()
                };
                
                // üî• THE GOD UPDATE: Move coins AND write to 3 different logs simultaneously!
                const updates = {};
                updates[`users/${state.user}/coins`] = state.coins - amt;
                updates[`users/${target}/coins`] = receiverCoins + amt;
                updates[`users/${state.user}/gifts/sent/${giftId}`] = giftRecord;
                updates[`users/${target}/gifts/received/${giftId}`] = giftRecord;
                updates[`global_gifts/${giftId}`] = giftRecord; // Master List in Firebase!

                await update(ref(db), updates);

                state.coins -= amt; // Update local state immediately
                updateUI();
                loadCloudData(); // Refresh logs

                showCustomAlert(`Successfully sent ${amt} points to ${target}!`, "Gift Sent!");

            } catch(e) {
                console.error(e);
                showCustomAlert("Gift failed due to network error.", "Error", true);
            }
        }

        window.renderGifts = function() {
            const vRec = document.getElementById('viewReceived'); 
            const vSent = document.getElementById('viewSent');
            
            if(state.gifts.received.length === 0) { 
                vRec.innerHTML = `<div style="text-align:center; opacity:0.5; margin-top:20px;">No gifts received yet.</div>`; 
            } else {
                vRec.innerHTML = state.gifts.received.sort((a,b)=>b.timestamp - a.timestamp).map(g => {
                    return `<div class="g-card"><h4>From: ${g.sender}</h4><p style="opacity:0.7; font-size:0.85rem;"><i class="fas fa-coins"></i> ${g.amount.toLocaleString()} Points</p></div>`;
                }).join('');
            }

            if(state.gifts.sent.length === 0) { 
                vSent.innerHTML = `<div style="text-align:center; opacity:0.5; margin-top:20px;">You haven't sent any gifts.</div>`; 
            } else {
                vSent.innerHTML = state.gifts.sent.sort((a,b)=>b.timestamp - a.timestamp).map(g => {
                    return `<div class="g-card"><h4>To: ${g.receiver}</h4><p style="opacity:0.7; font-size:0.85rem;"><i class="fas fa-coins"></i> ${g.amount.toLocaleString()} Points</p></div>`;
                }).join('');
            }
        }

        // --- UI RENDERERS ---
        window.syncUniversalAuth = function() {
            const footer = document.getElementById('sidebarAuth');
            
            // 4 Circles Created Here
            const themeIcon = document.body.getAttribute('data-theme') === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            const creatorBtn = `<a href="https://edupulses.github.io/EduPulses/about.html" target="_blank" class="circle-btn" title="Creator Info"><i class="fas fa-code"></i></a>`;
            const altBtn = `<a href="alt.html" class="circle-btn" title="Spyraz Web Page"><i class="fas fa-globe"></i></a>`;
            const themeBtn = `<button class="circle-btn" onclick="toggleTheme()" title="Toggle Theme">${themeIcon}</button>`;
            
            if (state.user) {
                const initial = state.user.charAt(0).toUpperCase();
                const profileBtn = `<button class="circle-btn profile-circle" title="Logged in as ${state.user}" onclick="logout()">${initial}</button>`;
                footer.innerHTML = profileBtn + creatorBtn + altBtn + themeBtn;
                loadCloudData();
                renderMarket();
            } else {
                const loginBtn = `<button class="circle-btn" style="background:var(--purple); color:white; border-color:var(--purple);" onclick="triggerLogin()" title="Login"><i class="fas fa-sign-in-alt"></i></button>`;
                footer.innerHTML = loginBtn + creatorBtn + altBtn + themeBtn;
                document.getElementById('displayUser').innerText = "Please Login"; 
                renderMarket();
            }
        }

        window.updateUI = function() {
            if(!state.user) return;
            document.getElementById('displayUser').innerText = state.user;
            document.getElementById('displayCoins').innerText = state.coins.toLocaleString();
        }

        window.showTab = function(type) {
            document.getElementById('marketView').style.display = type === 'market' ? 'grid' : 'none';
            document.getElementById('inventoryView').style.display = type === 'inventory' ? 'grid' : 'none';
            document.getElementById('marketBtn').classList.toggle('active', type === 'market');
            document.getElementById('inventoryBtn').classList.toggle('active', type === 'inventory');
        }

        window.renderMarket = function() {
            const container = document.getElementById('marketView'); container.innerHTML = "";
            for (let name in FRUITS) {
                const card = document.createElement('div'); card.className = 'item-card';
                card.innerHTML = `<div><h3>${name}</h3><p class="price"><i class="fas fa-coins" style="font-size:0.9rem;"></i> ${FRUITS[name].toLocaleString()}</p></div><button class="btn btn-buy" onclick="buyFruit('${name}')">BUY</button>`;
                container.appendChild(card);
            }
        }

        window.renderInventory = function() {
            const container = document.getElementById('inventoryView'); container.innerHTML = "";
            if (!state.user) return container.innerHTML = "<div style='grid-column: 1/-1; text-align:center; padding:40px; background:var(--card); border-radius:20px; border:1px solid var(--border);'><i class='fas fa-lock' style='font-size:2.5rem; color:var(--accent); margin-bottom:15px;'></i><h2>Locked</h2><p style='opacity:0.5;'>Log in to view inventory.</p></div>";

            let count = 0;
            for (let name in state.inventory) {
                if (state.inventory[name] > 0) {
                    count++;
                    const card = document.createElement('div'); card.className = 'item-card';
                    card.innerHTML = `<span class="count-badge">x${state.inventory[name]}</span><div><h3>${name}</h3><p class="price" style="color:var(--success);"><i class="fas fa-arrow-up" style="font-size:0.9rem;"></i> ${FRUITS[name].toLocaleString()}</p></div><button class="btn btn-sell" onclick="sellFruit('${name}')">SELL</button>`;
                    container.appendChild(card);
                }
            }
            if (count === 0) container.innerHTML = "<div style='grid-column: 1/-1; text-align:center; padding:40px; background:var(--card); border-radius:20px; border:1px solid var(--border);'><i class='fas fa-box-open' style='font-size:2.5rem; color:var(--accent); margin-bottom:15px;'></i><h2>Empty</h2><p style='opacity:0.5;'>Spin the daily gacha to get fruits!</p></div>";
        }

        window.buyFruit = function(name) {
            if(!state.user) return triggerLogin();
            const price = FRUITS[name];
            if (state.coins < price) return showCustomAlert("You do not have enough points.", "Failed", true);
            
            state.coins -= price; 
            state.inventory[name] = (state.inventory[name] || 0) + 1;
            
            updateUI(); renderInventory(); 
            syncCloud();
            showCustomAlert(`Added ${name} to your inventory!`, "Purchased");
        }

        window.sellFruit = function(name) {
            if (!state.inventory[name] || state.inventory[name] <= 0) return;
            
            state.coins += FRUITS[name]; 
            state.inventory[name]--;
            
            updateUI(); renderInventory(); 
            syncCloud();
            showCustomAlert(`Sold ${name} for ${FRUITS[name].toLocaleString()} points.`, "Sold");
        }

        window.toggleMenu = function() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('active'); }
        window.toggleTheme = function() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme); localStorage.setItem('theme', newTheme);
            syncUniversalAuth();
        }

        window.onload = () => {
            const saved = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', saved);
            syncUniversalAuth();
        };
    </script>
</body>
</html>